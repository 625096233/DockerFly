<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>DockerFly</title>
</head>
<link rel="shortcut icon" type="image/x-icon" href="img/favicon.ico"/>
<link rel="stylesheet" href="css/uikit/uikit.css"/>
<script src="js/common/jquery.min.js"></script>
<script src="js/common/vue.min.js"></script>
<script src="js/common/uikit.js"></script>

<link rel="stylesheet" href="css/main.css"/>
<script lang="javascript" src="js/utils.js"></script>
<script lang="javascript">
    doImport("org.voovan.docker.command.Container.CmdContainerList")
    doImport("org.voovan.docker.command.Container.CmdContainerLogs")
    doImport("org.voovan.docker.command.Container.CmdContainerTop")
    doImport("org.voovan.docker.command.Container.CmdContainerTop")
    doImport("org.voovan.docker.command.Container.CmdContainerStats")
    doImport("org.voovan.docker.command.Exec.CmdExecCreate")
    doImport("org.voovan.docker.command.Exec.CmdExecStart")

    function init() {
        viewerVue = new Vue({
            el: '#viewerApp',
            data: {
                logInfo :{
                    data: "",
                    timeStamp: null,
                    interval: 1,
                    loop: null,
                    cmdObject: null
                },
                stats : null,
                processes: null,
                execInfo: {
                    cmd: "ifconfig",
                    data: "",
                    interval : 1,
                    loop : null,
                    cmdObject: null
                }
            },
            updated: function(){
                logPanel.scrollTop = logPanel.scrollHeight;
                execPanel.scrollTop = execPanel.scrollHeight;
            },
            computed: {
                viewContainer: function () {
                    try {

                        var containerId = getQueryString("id");
                        var cmdContainerList = new CmdContainerList()
                        cmdContainerList.all(true);
                        cmdContainerList.id([containerId])
                        var viewContainer = cmdContainerList.send();
                        cmdContainerList.close();
                        cmdContainerList.release();
                        if(viewContainer.length == 1){
                            document.title = delFirestChar(viewContainer[0].names[0]) +
                                " [" +viewContainer[0].state+"] DockerFly";
                            return viewContainer[0];
                        }else {
                            return null;
                        }
                    } catch (e) {
                        alertError(e)
                    }
                }
            },
            methods:{
                logView: function(){
                    try{
                        if(this.logInfo.loop !=null){
                            alert("Log view is running.")
                            return;
                        }

                        var cmdContainerLogs = new CmdContainerLogs(this.viewContainer.id);
                        this.logInfo.cmdObject = cmdContainerLogs;
                        this.logInfo.loop = setInterval(
                            function() {
                                if(viewerVue.logInfo.timeStamp==null) {
                                    cmdContainerLogs.tail("15");
                                }else{
                                    cmdContainerLogs.tail("all");
                                    cmdContainerLogs.since(viewerVue.logInfo.timeStamp+1);
                                }

                                viewerVue.logInfo.timeStamp = parseInt(currentTimeMills() / 1000);

                                var logData = cmdContainerLogs.send();
                                viewerVue.logInfo.data += logData.replaceAll("\n", "<br/>");
                            }, this.logInfo.interval*1000
                        );
                    } catch (e) {
                        alertError(e);
                    }
                },

                logStop: function(){
                    clearInterval(this.logInfo.loop)
                    this.logInfo.loop = null;
                    if(this.execInfo.cmdObject!=null) {
                        this.logInfo.cmdObject.close();
                        this.logInfo.cmdObject.release();
                    }
                    this.logInfo.cmdObject = null;
                },

                logClear: function(){
                    this.logInfo.data = "";
                },

                processView: function(){
                    try{
                        var cmdContainerTop = new CmdContainerTop(this.viewContainer.id)
                        this.processes = cmdContainerTop.send();
                        cmdContainerTop.close();
                        cmdContainerTop.release();
                    } catch (e) {
                        alertError(e);
                    }
                },
                statsView: function(){
                    try{
                        var cmdContainerStats = new CmdContainerStats(this.viewContainer.id)
                        var data = cmdContainerStats.send();
                        cmdContainerStats.close();
                        cmdContainerStats.release();

                        this.stats = {};
                        this.stats.cpu = (data.cpuUsage/data.cpuTotal*100).toFixed(2);
                        this.stats.memUsage  = (data.memoryUsage/1024/1024).toFixed(2);
                        this.stats.memeLimit = (data.memoryMaxLimit/1024/1024).toFixed(2);
                        this.stats.ioRead  = (data.ioRead/1000).toFixed(0);
                        this.stats.ioSend  = (data.ioWrite/1000).toFixed(0);
                        this.stats.ioTotal = (data.ioTotal/1000).toFixed(0);
                        this.stats.netRx = (data.netRxBytes/1000).toFixed(0);
                        this.stats.netTx = (data.netTxBytes/1000).toFixed(0);
                    } catch (e) {
                        alertError(e);
                    }
                },

                execute: function(){
                    try {
                        if(this.execInfo.loop !=null){
                            alert("Executor is running.")
                            return;
                        }

                        var cmdExecCreate = new CmdExecCreate(this.viewContainer.id);
                        cmdExecCreate.cmd(this.execInfo.cmd.split(" "));
                        var execId = cmdExecCreate.send();
                        cmdExecCreate.close();
                        cmdExecCreate.release();

                        this.execInfo.data += "root@"+shortDockerId(this.viewContainer.id,12)+"# "+this.execInfo.cmd+"<br/>";

                        var cmdExecStart = new CmdExecStart(execId);
                        cmdExecStart.send();
                        cmdExecStart.beginLoadStream();

                        this.execInfo.cmdObject = cmdExecStart;

                        this.execInfo.loop = setInterval(
                            function () {
                                var tmp = null;
                                try {
                                    var tmp = cmdExecStart.loadStream();
                                }catch (e){
                                    tmp = null;
                                }

                                if (tmp != null) {
                                    viewerVue.execInfo.data += tmp.replaceAll("\n", "<br/>");
                                } else {
                                    clearInterval(viewerVue.execInfo.loop);
                                    viewerVue.execInfo.loop = null;
                                    cmdExecStart.endLoadStream();
                                    cmdExecStart.close();
                                    cmdExecStart.release();
                                }
                            }, this.execInfo.interval*1000);
                    } catch (e) {
                        clearInterval(this.execInfo.loop );
                        alertError(e);
                    }
                },

                execStop: function(){
                    clearInterval(this.execInfo.loop)
                    this.execInfo.loop = null;
                    if(this.execInfo.cmdObject!=null) {
                        this.execInfo.cmdObject.close();
                        this.execInfo.cmdObject.release();
                    }
                    this.execInfo.cmdObject=null;
                },

                execClear: function(){
                    this.execInfo.data = "";
                },
            }
        });

        viewerVue.processView();
        viewerVue.statsView();
    }
</script>
<body onload="init()" class="frameBody" style="padding-right: 35px">
<div id="viewerApp" style="display: none" v-show="this.viewContainer!=null">
    <div class="uk-width-6-6">
        <div class="uk-panel"></div>
        <h3 class="uk-text-middle"><span class="uk-text-danger uk-text-bold uk-text-large">
            {{viewContainer.names[0]|delFirestChar}}</span> [ {{viewContainer.state}} ]
        </h3>
        <ul class="uk-tab" data-uk-switcher="{connect:'#Viewers'}">
            <li><a href="#">Performance</a></li>
            <li><a href="#">Execute</a></li>
            <li><a href="#">Log</a></li>
        </ul>
        <div id="Viewers" class="uk-switcher" style="padding-top:15px">
            <!-- 性能信息 -->
            <div>

                <div>
                    <table class="uk-table uk-table-condensed uk-overflow-container uk-panel-box">
                        <caption>
                            <div class="uk-grid" style="margin-bottom: 3px">
                                <div class="uk-width-5-6">Status</div>
                                <div class="uk-width-1-6 uk-text-center">
                                    <a class="uk-button uk-button-small uk-button-primary" @click="statsView">Refresh</a>
                                </div>
                            </div>
                        </caption>
                        <thead>
                        <th class="uk-width-1-4 uk-text-center">CPU</th>
                        <th class="uk-width-1-4 uk-text-center">Memory(Usage/Limit)</th>
                        <th class="uk-width-1-4 uk-text-center">IO(Read/Send/Total)</th>
                        <th class="uk-width-1-4 uk-text-center">Net(Rx/Tx)</th>
                        </thead>
                        <tbody>
                        <tr v-if="stats!=null">
                            <td class="uk-text-center">{{stats.cpu}}%</td>
                            <td class="uk-text-center">{{stats.memUsage}} MB / {{stats.memeLimit}} MB</td>
                            <td class="uk-text-center">{{stats.ioRead}} KB / {{stats.ioSend}} KB / {{stats.ioTotal}} KB</td>
                            <td class="uk-text-center">{{stats.netRx}} KB / {{stats.netTx}} KB</td>
                        </tr>
                        </tbody>
                    </table>
                    <hr/>
                    <table class="uk-table uk-table-condensed uk-overflow-container uk-panel-box">
                        <caption>
                            <div class="uk-grid"  style="margin-bottom: 3px">
                                <div class="uk-width-5-6">Container process</div>
                                <div class="uk-width-1-6 uk-text-center">
                                    <a class="uk-button uk-button-small uk-button-primary" @click="processView">Refresh</a>
                                </div>
                            </div>
                        </caption>
                        <thead>
                        <th class="uk-width-1-10 uk-text-center">NO.</th>
                        <th class="uk-width-1-10">PID</th>
                        <th class="uk-width-1-10">User</th>
                        <th class="uk-width-1-10">Time</th>
                        <th class="uk-width-6-10">Command</th>
                        </thead>
                        <tbody>
                            <tr v-for="(proecess,index) in processes">
                                <td class="uk-text-center uk-text-middle uk-text-small">{{index}}</td>
                                <td>{{proecess.pid}}</td>
                                <td>{{proecess.user}}</td>
                                <td>{{proecess.time}}</td>
                                <td>{{proecess.command}}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- 执行命令 -->
            <div>
                <div class="uk-grid uk-form">
                    <div class="uk-width-4-6">
                        <input class="uk-form-width-large" type="text"
                               placeholder="Command will be execute in contianer" v-model="execInfo.cmd"/>
                    </div>
                    <div class="uk-width-2-6 uk-text-right">
                        <a class="uk-button uk-button-small uk-button-primary"
                           @click="execute" v-show="execInfo.loop==null">Run</a>
                        <a class="uk-button uk-button-small uk-button-danger"
                           @click="execStop" v-show="execInfo.loop!=null">Stop</a>
                        <a class="uk-button uk-button-small uk-button-success" @click="execClear">Clear</a>
                    </div>
                </div>
                <hr>
                <div id="execPanel" v-html="execInfo.data" class="terminal" style="height:400px; overflow-y: scroll;"></div>
            </div>
            <!-- 日志 -->
            <div>
                <div class="uk-grid uk-form">
                    <div class="uk-width-4-6" style="line-height: 30px">
                        <code>{{viewContainer==null?"":viewContainer.command}}</code>
                    </div>
                    <div class="uk-width-2-6 uk-text-right">
                        <a class="uk-button uk-button-small uk-button-primary"
                           @click="logView" v-show="logInfo.loop==null">Fetch</a>
                        <a class="uk-button uk-button-small uk-button-danger"
                           @click="logStop" v-show="logInfo.loop!=null">Stop</a>
                        <a class="uk-button uk-button-small uk-button-success" @click="logClear">Clear</a>
                    </div>
                </div>
                <hr>
                <div id="logPanel" v-html="logInfo.data" class="terminal" style="height:400px; overflow-y: scroll;"></div>
            </div>
        </div>
    </div>
</div>

</body>
</html>