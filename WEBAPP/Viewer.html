<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>DockerFly</title>
</head>
<link rel="shortcut icon" type="image/x-icon" href="img/favicon.ico"/>
<link rel="stylesheet" href="css/uikit/uikit.css"/>
<script src="js/common/jquery.min.js"></script>
<script src="js/common/vue.min.js"></script>
<script src="js/common/uikit.js"></script>

<link rel="stylesheet" href="css/main.css"/>
<script lang="javascript" src="js/utils.js"></script>
<script lang="javascript">
    doImport("org.voovan.docker.command.Container.CmdContainerList")
    doImport("org.voovan.docker.command.Container.CmdContainerLogs")
    doImport("org.voovan.docker.command.Container.CmdContainerTop")
    doImport("org.voovan.docker.command.Container.CmdContainerTop")
    doImport("org.voovan.docker.command.Container.CmdContainerStats")

    function init() {
        viewerVue = new Vue({
            el: '#viewerApp',
            data: {
                logInfo :{
                    logData: "",
                    logTimeStamp: null,
                    logInterval: 1
                },
                stats : null,
                processes: null
            },
            updated: function(){
                logPanel.scrollTop = logPanel.scrollHeight;
            },
            computed: {
                viewContainer: function () {
                    try {

                        var containerId = getQueryString("id");
                        var cmdContainerList = new CmdContainerList()
                        cmdContainerList.all(true);
                        cmdContainerList.id([containerId])
                        var viewContainer = cmdContainerList.send();
                        cmdContainerList.close();
                        cmdContainerList.release();
                        if(viewContainer.length == 1){
                            document.title = delFirestChar(viewContainer[0].names[0]) +
                                " [" +viewContainer[0].state+"] DockerFly";
                            return viewContainer[0];
                        }else {
                            return null;
                        }
                    } catch (e) {
                        alertError(e)
                    }
                }
            },
            methods:{
                logView: function(){
                    var cmdContainerLogs = new CmdContainerLogs(this.viewContainer.id);

                    if(this.logInfo.logTimeStamp==null) {
                        cmdContainerLogs.tail("15");
                    }else{
                        cmdContainerLogs.tail("all");
                        cmdContainerLogs.since(this.logInfo.logTimeStamp+1);
                    }

                    this.logInfo.logTimeStamp = parseInt(currentTimeMills() / 1000);

                    var logData = cmdContainerLogs.send();
                    var logPanel = document.getElementById('logPanel');
                    this.logInfo.logData += logData.replaceAll("\n","<br/>");

                    cmdContainerLogs.close();
                    cmdContainerLogs.release();
                },

                logClean: function(){
                    this.logInfo.logData = "";
                },

                processView: function(){
                    var cmdContainerTop = new CmdContainerTop(this.viewContainer.id)
                    this.processes = cmdContainerTop.send();
                    cmdContainerTop.close();
                    cmdContainerTop.release();
                },
                statsView: function(){
                    var cmdContainerStats = new CmdContainerStats(this.viewContainer.id)
                    var data = cmdContainerStats.send();
                    cmdContainerStats.close();
                    cmdContainerStats.release();

                    this.stats = {};
                    this.stats.cpu = (data.cpuUsage/data.cpuTotal*100).toFixed(2);
                    this.stats.memUsage  = (data.memoryUsage/1024/1024).toFixed(2);
                    this.stats.memeLimit = (data.memoryMaxLimit/1024/1024).toFixed(2);
                    this.stats.ioRead  = (data.ioRead/1000).toFixed(0);
                    this.stats.ioSend  = (data.ioWrite/1000).toFixed(0);
                    this.stats.ioTotal = (data.ioTotal/1000).toFixed(0);
                    this.stats.netRx = (data.netRxBytes/1000).toFixed(0);
                    this.stats.netTx = (data.netTxBytes/1000).toFixed(0);
                }
            }
        });

        viewerVue.processView();
        viewerVue.statsView();
    }
</script>
<body onload="init()" class="frameBody" style="padding-right: 35px">
<div id="viewerApp" style="display: none" v-show="this.viewContainer!=null">
    <div class="uk-width-6-6">
        <div class="uk-panel"></div>
        <h3 class="uk-text-middle"><span class="uk-text-danger uk-text-bold uk-text-large">
            {{viewContainer.names[0]|delFirestChar}}</span> [ {{viewContainer.state}} ]
        </h3>
        <ul class="uk-tab" data-uk-switcher="{connect:'#Viewers'}">
            <li><a href="#">Performance</a></li>
            <li><a href="#">Log</a></li>
        </ul>
        <div id="Viewers" class="uk-switcher" style="padding-top:15px">
            <!-- 性能信息 -->
            <div>

                <div>
                    <table class="uk-table uk-table-condensed uk-overflow-container uk-panel-box">
                        <caption>
                            <div class="uk-grid" style="margin-bottom: 3px">
                                <div class="uk-width-5-6">Status</div>
                                <div class="uk-width-1-6 uk-text-center">
                                    <a class="uk-button uk-button-mini uk-button-primary" @click="statsView">Refresh</a>
                                </div>
                            </div>
                        </caption>
                        <thead>
                        <th class="uk-width-1-4 uk-text-center">CPU</th>
                        <th class="uk-width-1-4 uk-text-center">Memory(Usage/Limit)</th>
                        <th class="uk-width-1-4 uk-text-center">IO(Read/Send/Total)</th>
                        <th class="uk-width-1-4 uk-text-center">Net(Rx/Tx)</th>
                        </thead>
                        <tbody>
                        <tr v-if="stats!=null">
                            <td class="uk-text-center">{{stats.cpu}}%</td>
                            <td class="uk-text-center">{{stats.memUsage}} MB / {{stats.memeLimit}} MB</td>
                            <td class="uk-text-center">{{stats.ioRead}} KB / {{stats.ioSend}} KB / {{stats.ioTotal}} KB</td>
                            <td class="uk-text-center">{{stats.netRx}} KB / {{stats.netTx}} KB</td>
                        </tr>
                        </tbody>
                    </table>

                    <hr/>
                    <table class="uk-table uk-table-condensed uk-overflow-container uk-panel-box">
                        <caption>
                            <div class="uk-grid"  style="margin-bottom: 3px">
                                <div class="uk-width-5-6">Container process</div>
                                <div class="uk-width-1-6 uk-text-center">
                                    <a class="uk-button uk-button-mini uk-button-primary" @click="processView">Refresh</a>
                                </div>
                            </div>
                        </caption>
                        <thead>
                        <th class="uk-width-1-10 uk-text-center">NO.</th>
                        <th class="uk-width-1-10">PID</th>
                        <th class="uk-width-1-10">User</th>
                        <th class="uk-width-1-10">Time</th>
                        <th class="uk-width-6-10">Command</th>
                        </thead>
                        <tbody>
                            <tr v-for="(proecess,index) in processes">
                                <td class="uk-text-center uk-text-middle uk-text-small">{{index}}</td>
                                <td>{{proecess.pid}}</td>
                                <td>{{proecess.user}}</td>
                                <td>{{proecess.time}}</td>
                                <td>{{proecess.command}}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- 日志 -->
            <div >
                <div class="uk-grid">
                    <div class="uk-width-5-6">
                        Command: <code>{{viewContainer==null?"":viewContainer.command}}</code>
                    </div>
                    <div class="uk-width-1-6 uk-text-center">
                        <a class="uk-button uk-button-mini uk-button-primary" @click="logView">Load</a>
                        <a class="uk-button uk-button-mini uk-button-success" @click="logClean">Clean</a>
                    </div>
                </div>
                <hr>
                <div id="logPanel" v-html="logInfo.logData" class="logPanel" style="height:400px; overflow-y: scroll;"></div>
            </div>
        </div>
    </div>
</div>

</body>
</html>